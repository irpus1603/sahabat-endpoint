{% extends 'core/base.html' %}
{% load static %}

{% block title %}People Counting - SOCA Edge{% endblock %}
{% block page_title %}People Counting Detection{% endblock %}
{% block page_subtitle %}Real-time People Counting Monitoring{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .detection-stats {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-active { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-danger { background-color: #dc3545; }
    
    .violation-alert {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .violation-count-card {
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .violation-count-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    #people-in-1day, #people-out-1day, #people-in-7days, #people-out-7days {
        transition: transform 0.3s ease;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- ApexCharts - Modern, Popular Chart Library -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Column - Video Stream -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-camera-video me-2"></i>
                    People Counting Detection Stream - {{ camera.name }}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="video-container">
                    <div id="video-debug" style="margin-bottom: 10px; padding: 5px; background: #f8f9fa; font-size: 12px;">
                        Stream URL: {% url 'people_counting_detection' camera.id %}
                    </div>
                    <img id="video-stream" 
                         src="{% url 'people_counting_detection' camera.id %}" 
                         alt="People Counting Detection Stream" 
                         class="img-fluid w-100"
                         style="object-fit: contain; max-height: 600px;"
                         onerror="console.error('Video stream failed to load:', this.src); this.style.border='2px solid red'; document.getElementById('video-debug').style.background='#ffebee';"
                         onload="console.log('Video stream loaded successfully:', this.src); document.getElementById('video-debug').style.background='#e8f5e8';">
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col-md-3">
                        <small class="text-muted">Status</small><br>
                        <span class="status-indicator status-active"></span>
                        <strong class="text-success">Active</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Resolution</small><br>
                        <strong>{{ camera.resolution|default:"HD" }}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">FPS</small><br>
                        <strong>{{ camera.fps|default:"25" }}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Source</small><br>
                        <strong>{{ camera.camera_source }}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- People Counting Graph - Moved below video -->
        <div class="card mt-3">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        People Counting - Last 6 Hours (30min intervals)
                    </h6>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshPeopleCountingChart()" title="Refresh Chart Data">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="chart-debug" style="margin-bottom: 10px; padding: 5px; background: #f8f9fa; font-size: 12px;">
                    Camera ID: {{ camera.id }} | Chart Status: Loading...
                </div>
                <div style="height: 300px; width: 100%;">
                    <div id="peopleCountingChart" data-camera-id="{{ camera.id }}"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Column - Real-time Data -->
    <div class="col-lg-4">
        <!-- People Counting Stats -->
        <div class="stats-card">
            <h6><i class="bi bi-people me-2"></i>People Counting Status</h6>
            <div id="people-counting-stats-content">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Current Occupancy</span>
                    <span class="h4 mb-0" id="current-occupancy">Loading...</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <span>Today's Traffic</span>
                    <span class="h5 mb-0" id="todays-traffic">Loading...</span>
                </div>
            </div>
        </div>
        
        
        <!-- People Counting Stats -->
        <div class="detection-stats">
            <h6 class="text-primary mb-3">
                <i class="bi bi-people-fill me-2"></i>People Counting Summary
            </h6>
            <div id="people-counting-counts">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="p-3 rounded" style="background: linear-gradient(135deg, #28A745 0%, #20A43A 100%); color: white;">
                            <h4 class="mb-0" id="people-in-1day">Loading...</h4>
                            <small class="opacity-90">IN - Last 24h</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 rounded" style="background: linear-gradient(135deg, #DC3545 0%, #C82333 100%); color: white;">
                            <h4 class="mb-0" id="people-out-1day">Loading...</h4>
                            <small class="opacity-90">OUT - Last 24h</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-2 rounded border-end" style="background: linear-gradient(135deg, #17A2B8 0%, #138496 100%); color: white;">
                            <h5 class="mb-0" id="people-in-7days">Loading...</h5>
                            <small class="opacity-90">IN - 7 Days</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-2 rounded" style="background: linear-gradient(135deg, #FD7E14 0%, #E8660C 100%); color: white;">
                            <h5 class="mb-0" id="people-out-7days">Loading...</h5>
                            <small class="opacity-90">OUT - 7 Days</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background: #f8f9fa;">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>Last Updated
                            </small>
                            <small class="text-muted" id="people-counting-last-updated">
                                {{ current_time|date:"H:i" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Daily Traffic Pattern Chart -->
        <div class="detection-stats mt-3">
            <h6 class="text-info mb-3">
                <i class="bi bi-graph-up me-2"></i>Daily Traffic Pattern (Last 7 Days)
            </h6>
            <div id="daily-traffic-chart" data-camera-id="{{ camera.id }}" style="height: 250px;"></div>
            <div class="mt-2">
                <small class="text-muted d-flex justify-content-between">
                    <span>People traffic by day</span>
                    <span id="traffic-chart-last-updated">Loading...</span>
                </small>
            </div>
        </div>
        
        <!-- Hourly Distribution Chart -->
        <div class="detection-stats mt-3">
            <h6 class="text-warning mb-3">
                <i class="bi bi-clock-history me-2"></i>Hourly Distribution (Last 7 Days)
            </h6>
            <div id="hourly-distribution-chart" data-camera-id="{{ camera.id }}" style="height: 250px;"></div>
            <div class="mt-2">
                <small class="text-muted d-flex justify-content-between">
                    <span>People traffic by hour</span>
                    <span id="hourly-chart-last-updated">Loading...</span>
                </small>
            </div>
        </div>
        
        <!-- System Information -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    System Information
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Camera ID:</span>
                        <span class="text-primary">{{ camera.id }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Detection Model:</span>
                        <span class="text-success">People-YOLOv11</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Confidence:</span>
                        <span class="text-warning">0.7</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Last Update:</span>
                        <span class="text-muted" id="current-time">
                            {{ current_time|date:"H:i:s" }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-gear me-2"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" onclick="downloadSnapshot()">
                        <i class="bi bi-camera me-2"></i>Take Snapshot
                    </button>
                    <button class="btn btn-outline-warning btn-sm" type="button" onclick="adjustSensitivity()">
                        <i class="bi bi-sliders me-2"></i>Adjust Sensitivity
                    </button>
                    <button class="btn btn-outline-danger btn-sm" type="button" onclick="triggerAlert()">
                        <i class="bi bi-exclamation-triangle me-2"></i>Trigger Alert
                    </button>
                    <button class="btn btn-outline-info btn-sm" type="button" onclick="exportReport()">
                        <i class="bi bi-file-earmark-arrow-down me-2"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Functions for quick actions
function downloadSnapshot() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = document.getElementById('video-stream');
    
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    ctx.drawImage(img, 0, 0);
    
    const link = document.createElement('a');
    link.download = `people-counting-snapshot-${Date.now()}.png`;
    link.href = canvas.toDataURL();
    link.click();
}

function adjustSensitivity() {
    // This would open a modal or redirect to settings
    alert('People counting sensitivity adjustment feature would be implemented here');
}

function triggerAlert() {
    // This would trigger a people counting alert
    if (confirm('Are you sure you want to trigger a people counting alert?')) {
        alert('People counting alert triggered! Management will be notified.');
    }
}

function exportReport() {
    // This would trigger a report generation
    alert('People counting report export feature would be implemented here');
}

// Auto-refresh video stream if it fails
document.getElementById('video-stream').onerror = function() {
    setTimeout(() => {
        this.src = this.src.split('?')[0] + '?t=' + Date.now();
    }, 5000);
};

// Update current time every second
setInterval(function() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {hour12: false});
    document.getElementById('current-time').textContent = timeString;
}, 1000);

// Create people counting chart
function createPeopleCountingChart() {
    try {
        const chartContainer = document.getElementById('peopleCountingChart');
        if (!chartContainer) {
            console.error('Chart container not found');
            return;
        }
        
        // Test API connectivity first
        console.log('Testing API connectivity...');
        fetch('/peoplecounting/api/test/')
            .then(response => response.json())
            .then(data => {
                console.log('API test result:', data);
            })
            .catch(error => {
                console.error('API test failed:', error);
            });
        
        // Get people counting data via AJAX
        const cameraId = chartContainer.dataset.cameraId;
        const apiUrl = '/peoplecounting/api/events/' + cameraId + '/';
        document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | API URL: ' + apiUrl + ' | Chart Status: Fetching data...';
        
        console.log('Fetching data from:', apiUrl);
        console.log('Current browser time:', new Date().toLocaleString());
        console.log('Expected time range: Last 6 hours from now');
        
        fetch(apiUrl)
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(peopleCountingData => {
                console.log('People counting data received:', peopleCountingData);
                console.log('Data labels (time periods):', peopleCountingData.labels);
                console.log('IN data:', peopleCountingData.in_data);
                console.log('OUT data:', peopleCountingData.out_data);
                console.log('Total IN data points:', peopleCountingData.in_data ? peopleCountingData.in_data.length : 0);
                console.log('Total OUT data points:', peopleCountingData.out_data ? peopleCountingData.out_data.length : 0);
                
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Data loaded, creating chart...';
                
                if (!peopleCountingData || !peopleCountingData.labels || (!peopleCountingData.in_data && !peopleCountingData.out_data)) {
                    console.error('Invalid people counting data structure');
                    document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Error - Invalid data structure';
                    return;
                }
                
                // Log time range for debugging
                const firstLabel = peopleCountingData.labels[0];
                const lastLabel = peopleCountingData.labels[peopleCountingData.labels.length - 1];
                console.log(`Chart time range: ${firstLabel} to ${lastLabel}`);
                
                // Create the chart with the fetched data
                createChartWithData(chartContainer, peopleCountingData);
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Chart created successfully | Time range: ' + firstLabel + ' to ' + lastLabel;
            })
            .catch(error => {
                console.error('Error fetching people counting data:', error);
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Error - No data available (' + error.message + ')';
                // Don't create chart if no real data available
                chartContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-exclamation-triangle"></i><br>No people counting data available</div>';
            });
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

function createChartWithData(chartContainer, peopleCountingData) {
    try {
        // Validate data before creating chart
        if (!peopleCountingData || !peopleCountingData.labels || (!peopleCountingData.in_data && !peopleCountingData.data)) {
            chartContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-info-circle"></i><br>No data available for selected time period</div>';
            return;
        }

        // ApexCharts Configuration
        const options = {
            series: [{
                name: 'People In',
                data: peopleCountingData.in_data || []
            }, {
                name: 'People Out',
                data: peopleCountingData.out_data || []
            }],
            chart: {
                type: 'bar',
                height: 300,
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 1200,
                    animateGradually: {
                        enabled: true,
                        delay: 100
                    }
                },
                background: 'transparent',
                foreColor: '#2C3E50'
            },
            plotOptions: {
                bar: {
                    borderRadius: 6,
                    columnWidth: '60%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val) {
                    // Only show labels for non-zero values
                    return val > 0 ? val : '';
                },
                offsetY: -25,
                style: {
                    fontSize: '12px',
                    fontWeight: 'bold',
                    colors: ['#E74C3C']
                },
                background: {
                    enabled: true,
                    foreColor: '#E74C3C',
                    borderColor: '#E74C3C',
                    borderWidth: 1,
                    borderRadius: 4,
                    padding: 4,
                    opacity: 0.1
                }
            },
            colors: ['#28A745', '#DC3545'],
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'light',
                    type: 'vertical',
                    shadeIntensity: 0.5,
                    gradientToColors: ['#C82333'],
                    inverseColors: false,
                    opacityFrom: 0.8,
                    opacityTo: 0.6,
                    stops: [0, 100]
                }
            },
            xaxis: {
                categories: peopleCountingData.labels,
                title: {
                    text: 'Time (Last 6 Hours - 30min intervals)',
                    style: {
                        fontSize: '12px',
                        fontWeight: 'bold',
                        color: '#2C3E50'
                    }
                },
                labels: {
                    style: {
                        fontSize: '10px',
                        colors: '#7F8C8D'
                    },
                    rotate: 0
                },
                axisBorder: {
                    show: true,
                    color: '#E0E0E0'
                },
                axisTicks: {
                    show: true,
                    color: '#E0E0E0'
                }
            },
            yaxis: {
                title: {
                    text: 'Number of People',
                    style: {
                        fontSize: '12px',
                        fontWeight: 'bold',
                        color: '#2C3E50'
                    }
                },
                labels: {
                    style: {
                        fontSize: '10px',
                        colors: '#7F8C8D'
                    },
                    formatter: function (val) {
                        return Math.floor(val) + (Math.floor(val) === 1 ? ' person' : ' people');
                    }
                },
                min: 0
            },
            title: {
                text: 'People Counting (Last 6 Hours - 30min intervals)',
                align: 'center',
                margin: 20,
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    color: '#2C3E50'
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '12px'
                },
                custom: function({series, seriesIndex, dataPointIndex, w}) {
                    const inValue = series[0][dataPointIndex];
                    const outValue = series[1][dataPointIndex];
                    const time = w.globals.labels[dataPointIndex];
                    const net = inValue - outValue;
                    
                    let status = '';
                    if (net > 5) {
                        status = '<div style="color: #FFC107;"><i class="bi bi-people-fill"></i> Status: High Traffic</div>';
                    } else if (net > 0) {
                        status = '<div style="color: #28A745;"><i class="bi bi-people"></i> Status: Normal Traffic</div>';
                    } else {
                        status = '<div style="color: #17A2B8;"><i class="bi bi-person"></i> Status: Low Traffic</div>';
                    }
                    
                    return `
                        <div style="padding: 10px; background: rgba(44, 62, 80, 0.95); border-radius: 6px; border: 1px solid #28A745;">
                            <div style="color: white; font-weight: bold; margin-bottom: 5px;">Time: ${time}</div>
                            <div style="color: white;">People In: ${inValue} | Out: ${outValue}</div>
                            <div style="color: white;">Net Flow: ${net > 0 ? '+' : ''}${net}</div>
                            ${status}
                        </div>
                    `;
                }
            },
            grid: {
                borderColor: 'rgba(127, 140, 141, 0.2)',
                strokeDashArray: 3,
                xaxis: {
                    lines: {
                        show: false
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                }
            },
            states: {
                hover: {
                    filter: {
                        type: 'lighten',
                        value: 0.1
                    }
                },
                active: {
                    allowMultipleDataPointsSelection: false,
                    filter: {
                        type: 'darken',
                        value: 0.1
                    }
                }
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    chart: {
                        height: 250
                    },
                    plotOptions: {
                        bar: {
                            columnWidth: '80%'
                        }
                    },
                    dataLabels: {
                        style: {
                            fontSize: '10px'
                        }
                    }
                }
            }]
        };

        // Create the chart
        peopleCountingChartInstance = new ApexCharts(chartContainer, options);
        peopleCountingChartInstance.render();
        
        console.log('Chart created successfully');
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

// Global chart variable to store the chart instance
let peopleCountingChartInstance = null;

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    createPeopleCountingChart();
    updatePeopleCountingCounts(); // Load initial people counting counts
    createDailyTrafficChart(); // Load daily traffic chart
    createHourlyDistributionChart(); // Load hourly distribution chart
    
    // Set up automatic refresh every 15 seconds for real-time data
    setInterval(function() {
        refreshPeopleCountingChart();
        updatePeopleCountingCounts();
        refreshDailyTrafficChart();
        refreshHourlyDistributionChart();
    }, 15000); // 15 seconds
});

// Function to refresh chart data
function refreshPeopleCountingChart() {
    const chartContainer = document.getElementById('peopleCountingChart');
    if (!chartContainer) {
        console.error('Chart container not found for refresh');
        return;
    }
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/peoplecounting/api/events/' + cameraId + '/';
    
    console.log('Refreshing chart data from:', apiUrl);
    document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Refreshing data...';
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(peopleCountingData => {
            console.log('Refreshed people counting data:', peopleCountingData);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Data refreshed, updating chart...';
            
            if (!peopleCountingData || !peopleCountingData.labels) {
                console.error('Invalid people counting data structure on refresh');
                return;
            }
            
            // Update existing chart with new data
            updateChartData(peopleCountingData);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Chart updated successfully (Last refresh: ' + new Date().toLocaleTimeString() + ')';
        })
        .catch(error => {
            console.error('Error refreshing people counting data:', error);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Refresh failed (' + error.message + ')';
        });
}

// Function to update chart data without recreating the chart
function updateChartData(newData) {
    if (peopleCountingChartInstance) {
        // ApexCharts update method
        peopleCountingChartInstance.updateSeries([{
            name: 'People In',
            data: newData.in_data || newData.data || []
        }, {
            name: 'People Out',
            data: newData.out_data || newData.data || []
        }]);
        
        // Update categories (x-axis labels)
        peopleCountingChartInstance.updateOptions({
            xaxis: {
                categories: newData.labels
            }
        });
        
        console.log('ApexChart data updated with animation');
    } else {
        console.error('PeopleCountingChart instance not found for update');
    }
}

// Function to update people counting counts for different time periods
function updatePeopleCountingCounts() {
    const chartContainer = document.getElementById('peopleCountingChart');
    if (!chartContainer) {
        console.error('Chart container not found for people counting counts update');
        return;
    }
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/peoplecounting/api/summary/' + cameraId + '/';
    
    console.log('Fetching people counting summary from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(summaryData => {
            console.log('People counting summary data:', summaryData);
            
            // Update the people counting displays with animation
            updateCountWithAnimation('people-in-1day', summaryData.people_in_1day || 0);
            updateCountWithAnimation('people-out-1day', summaryData.people_out_1day || 0);
            updateCountWithAnimation('people-in-7days', summaryData.people_in_7days || 0);
            updateCountWithAnimation('people-out-7days', summaryData.people_out_7days || 0);
            updateCountWithAnimation('current-occupancy', summaryData.current_occupancy || 0);
            updateCountWithAnimation('todays-traffic', summaryData.todays_traffic || 0);
            
            // Update last updated time
            document.getElementById('people-counting-last-updated').textContent = summaryData.last_updated || new Date().toLocaleTimeString();
            
            console.log('People counting updated successfully');
        })
        .catch(error => {
            console.error('Error fetching people counting summary:', error);
            // Show error state, no fallback values
            document.getElementById('people-in-1day').textContent = 'Error';
            document.getElementById('people-out-1day').textContent = 'Error';
            document.getElementById('people-in-7days').textContent = 'Error';
            document.getElementById('people-out-7days').textContent = 'Error';
            document.getElementById('current-occupancy').textContent = 'Error';
            document.getElementById('todays-traffic').textContent = 'Error';
            document.getElementById('people-counting-last-updated').textContent = 'Failed to load data';
        });
}

// Function to animate count updates
function updateCountWithAnimation(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentValue = parseInt(element.textContent) || 0;
    
    if (currentValue !== newValue) {
        // Add animation class
        element.style.transform = 'scale(1.1)';
        element.style.transition = 'transform 0.3s ease';
        
        // Update value after short delay
        setTimeout(() => {
            element.textContent = newValue;
            element.style.transform = 'scale(1)';
        }, 150);
    } else {
        element.textContent = newValue;
    }
}

// Global variables for people counting charts
let dailyTrafficChartInstance = null;
let hourlyDistributionChartInstance = null;

// Function to create daily traffic chart
function createDailyTrafficChart() {
    try {
        const chartContainer = document.getElementById('daily-traffic-chart');
        if (!chartContainer) {
            console.error('Daily traffic chart container not found');
            return;
        }
        
        const cameraId = chartContainer.dataset.cameraId;
        const apiUrl = '/peoplecounting/api/daily-traffic/' + cameraId + '/';
        
        console.log('Fetching daily traffic data from:', apiUrl);
        document.getElementById('traffic-chart-last-updated').textContent = 'Loading...';
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Daily traffic data:', data);
                createDailyTrafficChartWithData(chartContainer, data);
                document.getElementById('traffic-chart-last-updated').textContent = new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error fetching daily traffic data:', error);
                chartContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-exclamation-triangle"></i><br>No daily traffic data available</div>';
                document.getElementById('traffic-chart-last-updated').textContent = 'Error - No data available';
            });
    } catch (error) {
        console.error('Error creating daily traffic chart:', error);
    }
}

// Function to create daily traffic chart with data
function createDailyTrafficChartWithData(chartContainer, data) {
    try {
        // Validate data before creating chart
        if (!data || !data.labels || !data.in_data || !data.out_data) {
            chartContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-info-circle"></i><br>No daily traffic data available</div>';
            return;
        }

        const options = {
            series: [{
                name: 'People In',
                data: data.in_data
            }, {
                name: 'People Out',
                data: data.out_data
            }],
            chart: {
                type: 'line',
                height: 250,
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 1000
                }
            },
            colors: ['#28A745', '#DC3545'],
            xaxis: {
                categories: data.labels,
                title: {
                    text: 'Days of Week'
                }
            },
            yaxis: {
                title: {
                    text: 'Number of People'
                }
            },
            legend: {
                position: 'top'
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val + ' people';
                    }
                }
            },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            markers: {
                size: 6
            }
        };

        dailyTrafficChartInstance = new ApexCharts(chartContainer, options);
        dailyTrafficChartInstance.render();
        
        console.log('Daily traffic chart created successfully');
    } catch (error) {
        console.error('Error creating daily traffic chart:', error);
    }
}

// Function to create hourly distribution chart
function createHourlyDistributionChart() {
    try {
        const chartContainer = document.getElementById('hourly-distribution-chart');
        if (!chartContainer) {
            console.error('Hourly distribution chart container not found');
            return;
        }
        
        const cameraId = chartContainer.dataset.cameraId;
        const apiUrl = '/peoplecounting/api/hourly-distribution/' + cameraId + '/';
        
        console.log('Fetching hourly distribution data from:', apiUrl);
        document.getElementById('hourly-chart-last-updated').textContent = 'Loading...';
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Hourly distribution data:', data);
                createHourlyDistributionChartWithData(chartContainer, data);
                document.getElementById('hourly-chart-last-updated').textContent = new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error fetching hourly distribution data:', error);
                chartContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-exclamation-triangle"></i><br>No hourly distribution data available</div>';
                document.getElementById('hourly-chart-last-updated').textContent = 'Error - No data available';
            });
    } catch (error) {
        console.error('Error creating hourly distribution chart:', error);
    }
}

// Function to create hourly distribution chart with data
function createHourlyDistributionChartWithData(chartContainer, data) {
    try {
        // Validate data before creating chart
        if (!data || !data.labels || !data.in_data || !data.out_data) {
            chartContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-info-circle"></i><br>No hourly distribution data available</div>';
            return;
        }

        const options = {
            series: [{
                name: 'People In',
                data: data.in_data
            }, {
                name: 'People Out',
                data: data.out_data
            }],
            chart: {
                type: 'bar',
                height: 250,
                stacked: false
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    columnWidth: '60%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            dataLabels: {
                enabled: true,
                offsetY: -20,
                style: {
                    fontSize: '10px',
                    colors: ['#304758']
                }
            },
            xaxis: {
                categories: data.labels,
                title: {
                    text: 'Time Periods'
                }
            },
            yaxis: {
                title: {
                    text: 'Number of People'
                }
            },
            colors: ['#28A745', '#DC3545'],
            title: {
                text: 'Hourly Traffic Distribution',
                align: 'center'
            },
            legend: {
                position: 'top'
            }
        };

        hourlyDistributionChartInstance = new ApexCharts(chartContainer, options);
        hourlyDistributionChartInstance.render();
        
        console.log('Hourly distribution chart created successfully');
    } catch (error) {
        console.error('Error creating hourly distribution chart:', error);
    }
}

// Function to refresh daily traffic chart
function refreshDailyTrafficChart() {
    const chartContainer = document.getElementById('daily-traffic-chart');
    if (!chartContainer) return;
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/peoplecounting/api/daily-traffic/' + cameraId + '/';
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (dailyTrafficChartInstance) {
                dailyTrafficChartInstance.updateSeries([{
                    name: 'People In',
                    data: data.in_data || []
                }, {
                    name: 'People Out',
                    data: data.out_data || []
                }]);
                document.getElementById('traffic-chart-last-updated').textContent = new Date().toLocaleTimeString();
            }
        })
        .catch(error => console.error('Error refreshing daily traffic chart:', error));
}

// Function to refresh hourly distribution chart
function refreshHourlyDistributionChart() {
    const chartContainer = document.getElementById('hourly-distribution-chart');
    if (!chartContainer) return;
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/peoplecounting/api/hourly-distribution/' + cameraId + '/';
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (hourlyDistributionChartInstance) {
                hourlyDistributionChartInstance.updateSeries([{
                    name: 'People In',
                    data: data.in_data || []
                }, {
                    name: 'People Out',
                    data: data.out_data || []
                }]);
                document.getElementById('hourly-chart-last-updated').textContent = new Date().toLocaleTimeString();
            }
        })
        .catch(error => console.error('Error refreshing hourly distribution chart:', error));
}
</script>
{% endblock %}