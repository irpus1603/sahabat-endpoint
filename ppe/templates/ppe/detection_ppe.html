{% extends 'core/base.html' %}
{% load static %}

{% block title %}PPE Detection - SOCA Edge{% endblock %}
{% block page_title %}PPE Detection{% endblock %}
{% block page_subtitle %}Real-time Personal Protective Equipment Monitoring{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .detection-stats {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-active { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-danger { background-color: #dc3545; }
    
    .violation-alert {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .violation-count-card {
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .violation-count-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    #violations-1day, #violations-7days, #violations-30days {
        transition: transform 0.3s ease;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- ApexCharts - Modern, Popular Chart Library -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Column - Video Stream -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-camera-video me-2"></i>
                    PPE Detection Stream - {{ camera.name }}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="video-container">
                    <div id="video-debug" style="margin-bottom: 10px; padding: 5px; background: #f8f9fa; font-size: 12px;">
                        Stream URL: {% url 'detection_ppe' camera.id %}
                    </div>
                    <img id="video-stream" 
                         src="{% url 'detection_ppe' camera.id %}" 
                         alt="PPE Detection Stream" 
                         class="img-fluid w-100"
                         style="object-fit: contain; max-height: 600px;"
                         onerror="console.error('Video stream failed to load:', this.src); this.style.border='2px solid red'; document.getElementById('video-debug').style.background='#ffebee';"
                         onload="console.log('Video stream loaded successfully:', this.src); document.getElementById('video-debug').style.background='#e8f5e8';">
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col-md-3">
                        <small class="text-muted">Status</small><br>
                        <span class="status-indicator status-active"></span>
                        <strong class="text-success">Active</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Resolution</small><br>
                        <strong>{{ camera.resolution|default:"HD" }}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">FPS</small><br>
                        <strong>{{ camera.fps|default:"25" }}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Source</small><br>
                        <strong>{{ camera.camera_source }}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Violations Graph - Moved below video -->
        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        PPE Violations - Last 6 Hours (30min intervals)
                    </h6>
                    <button class="btn btn-sm btn-outline-dark" onclick="refreshViolationsChart()" title="Refresh Chart Data">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="chart-debug" style="margin-bottom: 10px; padding: 5px; background: #f8f9fa; font-size: 12px;">
                    Camera ID: {{ camera.id }} | Chart Status: Loading...
                </div>
                <div style="height: 300px; width: 100%;">
                    <div id="violationsChart" data-camera-id="{{ camera.id }}"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Column - Real-time Data -->
    <div class="col-lg-4">
        <!-- PPE Detection Stats -->
        <div class="stats-card">
            <h6><i class="bi bi-shield-check me-2"></i>PPE Detection Status</h6>
            <div id="ppe-stats-content">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Compliance Rate</span>
                    <span class="h4 mb-0">85%</span>
                </div>
            </div>
        </div>
        
        
        <!-- Violation Counts -->
        <div class="detection-stats">
            <h6 class="text-primary mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>Violation Counts
            </h6>
            <div id="violation-counts">
                <div class="row text-center">
                    <div class="col-12 mb-3">
                        <div class="p-3 rounded" style="background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%); color: white;">
                            <h4 class="mb-0" id="violations-1day">0</h4>
                            <small class="opacity-90">Last 24 Hours</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-2 rounded border-end" style="background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%); color: white;">
                            <h5 class="mb-0" id="violations-7days">0</h5>
                            <small class="opacity-90">Last 7 Days</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-2 rounded" style="background: linear-gradient(135deg, #9B59B6 0%, #8E44AD 100%); color: white;">
                            <h5 class="mb-0" id="violations-30days">0</h5>
                            <small class="opacity-90">Last 30 Days</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background: #f8f9fa;">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>Last Updated
                            </small>
                            <small class="text-muted" id="violations-last-updated">
                                {{ current_time|date:"H:i" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PPE Equipment Violations Chart -->
        <div class="detection-stats mt-3">
            <h6 class="text-danger mb-3">
                <i class="bi bi-shield-x me-2"></i>PPE Equipment Violations (Last 7 Days)
            </h6>
            <div id="ppe-equipment-chart" data-camera-id="{{ camera.id }}" style="height: 250px;"></div>
            <div class="mt-2">
                <small class="text-muted d-flex justify-content-between">
                    <span>Total violations by equipment type</span>
                    <span id="ppe-chart-last-updated">Loading...</span>
                </small>
            </div>
        </div>
        
        <!-- System Information -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    System Information
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Camera ID:</span>
                        <span class="text-primary">{{ camera.id }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Detection Model:</span>
                        <span class="text-success">PPE-YOLOv8</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Confidence:</span>
                        <span class="text-warning">0.7</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Last Update:</span>
                        <span class="text-muted" id="current-time">
                            {{ current_time|date:"H:i:s" }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-gear me-2"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" onclick="downloadSnapshot()">
                        <i class="bi bi-camera me-2"></i>Take Snapshot
                    </button>
                    <button class="btn btn-outline-warning btn-sm" type="button" onclick="adjustSensitivity()">
                        <i class="bi bi-sliders me-2"></i>Adjust Sensitivity
                    </button>
                    <button class="btn btn-outline-info btn-sm" type="button" onclick="exportReport()">
                        <i class="bi bi-file-earmark-arrow-down me-2"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Functions for quick actions
function downloadSnapshot() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = document.getElementById('video-stream');
    
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    ctx.drawImage(img, 0, 0);
    
    const link = document.createElement('a');
    link.download = `ppe-snapshot-${Date.now()}.png`;
    link.href = canvas.toDataURL();
    link.click();
}

function adjustSensitivity() {
    // This would open a modal or redirect to settings
    alert('Sensitivity adjustment feature would be implemented here');
}

function exportReport() {
    // This would trigger a report generation
    alert('Report export feature would be implemented here');
}

// Auto-refresh video stream if it fails
document.getElementById('video-stream').onerror = function() {
    setTimeout(() => {
        this.src = this.src.split('?')[0] + '?t=' + Date.now();
    }, 5000);
};

// Update current time every second
setInterval(function() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {hour12: false});
    document.getElementById('current-time').textContent = timeString;
}, 1000);

// Create violations chart
function createViolationsChart() {
    try {
        const chartContainer = document.getElementById('violationsChart');
        if (!chartContainer) {
            console.error('Chart container not found');
            return;
        }
        
        // Test API connectivity first
        console.log('Testing API connectivity...');
        fetch('/ppe/api/test/')
            .then(response => response.json())
            .then(data => {
                console.log('API test result:', data);
            })
            .catch(error => {
                console.error('API test failed:', error);
            });
        
        // Get violation data via AJAX
        const cameraId = chartContainer.dataset.cameraId;
        const apiUrl = '/ppe/api/violations/' + cameraId + '/';
        document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | API URL: ' + apiUrl + ' | Chart Status: Fetching data...';
        
        console.log('Fetching data from:', apiUrl);
        console.log('Current browser time:', new Date().toLocaleString());
        fetch(apiUrl)
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(violationData => {
                console.log('Violation data:', violationData);
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Data loaded, creating chart...';
                
                if (!violationData || !violationData.labels || !violationData.data) {
                    console.error('Invalid violation data structure');
                    document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Error - Invalid data structure';
                    return;
                }
                
                // Create the chart with the fetched data
                createChartWithData(chartContainer, violationData);
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Chart created successfully';
            })
            .catch(error => {
                console.error('Error fetching violation data:', error);
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Error - Using fallback data (' + error.message + ')';
                // Use fallback data for last 6 hours with 30-minute intervals (Jakarta time)
                const now = new Date();
                const fallbackLabels = [];
                
                // Round up to next hour (matching backend logic)
                const endTime = new Date(now);
                endTime.setHours(endTime.getHours() + 1, 0, 0, 0);
                
                const startTime = new Date(endTime.getTime() - (6 * 60 * 60 * 1000));
                
                console.log('JavaScript fallback time range:', startTime.toLocaleString(), '→', endTime.toLocaleString());
                
                for (let i = 0; i < 12; i++) {
                    const timePoint = new Date(startTime.getTime() + (i * 30 * 60 * 1000));
                    const hours = timePoint.getHours().toString().padStart(2, '0');
                    const minutes = timePoint.getMinutes().toString().padStart(2, '0');
                    fallbackLabels.push(hours + ':' + minutes);
                }
                
                console.log('JavaScript fallback labels:', fallbackLabels);
                const fallbackData = {
                    labels: fallbackLabels,
                    data: [2, 1, 0, 3, 1, 0, 2, 4, 1, 2, 0, 1]
                };
                createChartWithData(chartContainer, fallbackData);
            });
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

function createChartWithData(chartContainer, violationData) {
    try {
        // ApexCharts Configuration
        const options = {
            series: [{
                name: 'PPE Violations',
                data: violationData.data
            }],
            chart: {
                type: 'bar',
                height: 300,
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 1200,
                    animateGradually: {
                        enabled: true,
                        delay: 100
                    }
                },
                background: 'transparent',
                foreColor: '#2C3E50'
            },
            plotOptions: {
                bar: {
                    borderRadius: 6,
                    columnWidth: '60%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val) {
                    // Only show labels for non-zero values
                    return val > 0 ? val : '';
                },
                offsetY: -25,
                style: {
                    fontSize: '12px',
                    fontWeight: 'bold',
                    colors: ['#E74C3C']
                },
                background: {
                    enabled: true,
                    foreColor: '#E74C3C',
                    borderColor: '#E74C3C',
                    borderWidth: 1,
                    borderRadius: 4,
                    padding: 4,
                    opacity: 0.1
                }
            },
            colors: ['#DC3545'],
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'light',
                    type: 'vertical',
                    shadeIntensity: 0.5,
                    gradientToColors: ['#C82333'],
                    inverseColors: false,
                    opacityFrom: 0.8,
                    opacityTo: 0.6,
                    stops: [0, 100]
                }
            },
            xaxis: {
                categories: violationData.labels,
                title: {
                    text: 'Time (Last 6 Hours - 30min intervals)',
                    style: {
                        fontSize: '12px',
                        fontWeight: 'bold',
                        color: '#2C3E50'
                    }
                },
                labels: {
                    style: {
                        fontSize: '10px',
                        colors: '#7F8C8D'
                    },
                    rotate: 0
                },
                axisBorder: {
                    show: true,
                    color: '#E0E0E0'
                },
                axisTicks: {
                    show: true,
                    color: '#E0E0E0'
                }
            },
            yaxis: {
                title: {
                    text: 'Number of People with Violations',
                    style: {
                        fontSize: '12px',
                        fontWeight: 'bold',
                        color: '#2C3E50'
                    }
                },
                labels: {
                    style: {
                        fontSize: '10px',
                        colors: '#7F8C8D'
                    },
                    formatter: function (val) {
                        return Math.floor(val) + (Math.floor(val) === 1 ? ' person' : ' people');
                    }
                },
                min: 0
            },
            title: {
                text: 'PPE Violations Count (Last 6 Hours - 30min intervals)',
                align: 'center',
                margin: 20,
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    color: '#2C3E50'
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '12px'
                },
                custom: function({series, seriesIndex, dataPointIndex, w}) {
                    const value = series[seriesIndex][dataPointIndex];
                    const time = w.globals.labels[dataPointIndex];
                    
                    let status = '';
                    if (value === 0) {
                        status = '<div style="color: #28A745;"><i class="bi bi-check-circle"></i> Status: Compliant</div>';
                    } else if (value <= 2) {
                        status = '<div style="color: #FFC107;"><i class="bi bi-exclamation-triangle"></i> Status: Minor Violations</div>';
                    } else {
                        status = '<div style="color: #DC3545;"><i class="bi bi-x-circle"></i> Status: Major Violations</div>';
                    }
                    
                    return `
                        <div style="padding: 10px; background: rgba(44, 62, 80, 0.95); border-radius: 6px; border: 1px solid #E74C3C;">
                            <div style="color: white; font-weight: bold; margin-bottom: 5px;">Time: ${time}</div>
                            <div style="color: white;">PPE Violations: ${value} ${value === 1 ? 'person' : 'people'}</div>
                            ${status}
                        </div>
                    `;
                }
            },
            grid: {
                borderColor: 'rgba(127, 140, 141, 0.2)',
                strokeDashArray: 3,
                xaxis: {
                    lines: {
                        show: false
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                }
            },
            states: {
                hover: {
                    filter: {
                        type: 'lighten',
                        value: 0.1
                    }
                },
                active: {
                    allowMultipleDataPointsSelection: false,
                    filter: {
                        type: 'darken',
                        value: 0.1
                    }
                }
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    chart: {
                        height: 250
                    },
                    plotOptions: {
                        bar: {
                            columnWidth: '80%'
                        }
                    },
                    dataLabels: {
                        style: {
                            fontSize: '10px'
                        }
                    }
                }
            }]
        };

        // Create the chart
        violationsChartInstance = new ApexCharts(chartContainer, options);
        violationsChartInstance.render();
        
        console.log('Chart created successfully');
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

// Global chart variable to store the chart instance
let violationsChartInstance = null;

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    createViolationsChart();
    updateViolationCounts(); // Load initial violation counts
    createPPEEquipmentChart(); // Load PPE equipment violations chart
    
    // Set up automatic refresh every 15 seconds for real-time data
    setInterval(function() {
        refreshViolationsChart();
        updateViolationCounts();
        refreshPPEEquipmentChart();
    }, 15000); // 15 seconds
});

// Function to refresh chart data
function refreshViolationsChart() {
    const chartContainer = document.getElementById('violationsChart');
    if (!chartContainer) {
        console.error('Chart container not found for refresh');
        return;
    }
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/ppe/api/violations/' + cameraId + '/';
    
    console.log('Refreshing chart data from:', apiUrl);
    document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Refreshing data...';
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(violationData => {
            console.log('Refreshed violation data:', violationData);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Data refreshed, updating chart...';
            
            if (!violationData || !violationData.labels || !violationData.data) {
                console.error('Invalid violation data structure on refresh');
                return;
            }
            
            // Update existing chart with new data
            updateChartData(violationData);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Chart updated successfully (Last refresh: ' + new Date().toLocaleTimeString() + ')';
        })
        .catch(error => {
            console.error('Error refreshing violation data:', error);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Refresh failed (' + error.message + ')';
        });
}

// Function to update chart data without recreating the chart
function updateChartData(newData) {
    if (violationsChartInstance) {
        // ApexCharts update method
        violationsChartInstance.updateSeries([{
            name: 'PPE Violations',
            data: newData.data
        }]);
        
        // Update categories (x-axis labels)
        violationsChartInstance.updateOptions({
            xaxis: {
                categories: newData.labels
            }
        });
        
        console.log('ApexChart data updated with animation');
    } else {
        console.error('ApexChart instance not found for update');
    }
}

// Function to update violation counts for different time periods
function updateViolationCounts() {
    const chartContainer = document.getElementById('violationsChart');
    if (!chartContainer) {
        console.error('Chart container not found for violation counts update');
        return;
    }
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/ppe/api/summary/' + cameraId + '/';
    
    console.log('Fetching violation summary from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(summaryData => {
            console.log('Violation summary data:', summaryData);
            
            // Update the violation count displays with animation
            updateCountWithAnimation('violations-1day', summaryData.violations_1day);
            updateCountWithAnimation('violations-7days', summaryData.violations_7days);
            updateCountWithAnimation('violations-30days', summaryData.violations_30days);
            
            // Update last updated time
            document.getElementById('violations-last-updated').textContent = summaryData.last_updated;
            
            console.log('Violation counts updated successfully');
        })
        .catch(error => {
            console.error('Error fetching violation summary:', error);
            // Use fallback values on error
            document.getElementById('violations-1day').textContent = '—';
            document.getElementById('violations-7days').textContent = '—';
            document.getElementById('violations-30days').textContent = '—';
        });
}

// Function to animate count updates
function updateCountWithAnimation(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentValue = parseInt(element.textContent) || 0;
    
    if (currentValue !== newValue) {
        // Add animation class
        element.style.transform = 'scale(1.1)';
        element.style.transition = 'transform 0.3s ease';
        
        // Update value after short delay
        setTimeout(() => {
            element.textContent = newValue;
            element.style.transform = 'scale(1)';
        }, 150);
    } else {
        element.textContent = newValue;
    }
}

// Global variable for PPE equipment chart
let ppeEquipmentChartInstance = null;

// Function to create PPE equipment violations chart
function createPPEEquipmentChart() {
    try {
        const chartContainer = document.getElementById('ppe-equipment-chart');
        if (!chartContainer) {
            console.error('PPE equipment chart container not found');
            return;
        }
        
        const cameraId = chartContainer.dataset.cameraId;
        const apiUrl = '/ppe/api/equipment-violations/' + cameraId + '/';
        
        console.log('Fetching PPE equipment data from:', apiUrl);
        document.getElementById('ppe-chart-last-updated').textContent = 'Loading...';
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('PPE equipment data:', data);
                createPPEEquipmentChartWithData(chartContainer, data);
                document.getElementById('ppe-chart-last-updated').textContent = new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error fetching PPE equipment data:', error);
                // Use fallback data
                const fallbackData = {
                    labels: ['Helmet', 'Vest', 'Goggles', 'Gloves', 'Shoes'],
                    data: [12, 8, 5, 3, 7]
                };
                createPPEEquipmentChartWithData(chartContainer, fallbackData);
                document.getElementById('ppe-chart-last-updated').textContent = 'Error - Using sample data';
            });
    } catch (error) {
        console.error('Error creating PPE equipment chart:', error);
    }
}

// Function to create PPE equipment chart with data
function createPPEEquipmentChartWithData(chartContainer, data) {
    try {
        const options = {
            series: data.data,
            chart: {
                type: 'donut',
                height: 250,
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 1000
                }
            },
            labels: data.labels,
            colors: ['#DC3545', '#FD7E14', '#FFC107', '#198754', '#0D6EFD'],
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        labels: {
                            show: true,
                            name: {
                                show: true,
                                fontSize: '14px',
                                fontWeight: 'bold',
                                color: '#2C3E50'
                            },
                            value: {
                                show: true,
                                fontSize: '16px',
                                fontWeight: 'bold',
                                color: '#E74C3C',
                                formatter: function (val) {
                                    return val + ' violations';
                                }
                            },
                            total: {
                                show: true,
                                label: 'Total',
                                fontSize: '14px',
                                fontWeight: 'bold',
                                color: '#2C3E50',
                                formatter: function (w) {
                                    const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    return total + ' violations';
                                }
                            }
                        }
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val, opts) {
                    const value = opts.w.globals.series[opts.seriesIndex];
                    return value > 0 ? value : '';
                },
                style: {
                    fontSize: '12px',
                    fontWeight: 'bold',
                    colors: ['#FFFFFF']
                },
                dropShadow: {
                    enabled: true,
                    top: 1,
                    left: 1,
                    blur: 1,
                    opacity: 0.8
                }
            },
            legend: {
                position: 'bottom',
                fontSize: '12px',
                fontWeight: 'normal',
                labels: {
                    colors: '#2C3E50'
                },
                markers: {
                    width: 12,
                    height: 12,
                    radius: 3
                },
                formatter: function(seriesName, opts) {
                    const value = opts.w.globals.series[opts.seriesIndex];
                    return seriesName + ': ' + value;
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '12px'
                },
                y: {
                    formatter: function (val, opts) {
                        const percentage = ((val / opts.globals.seriesTotals.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                        return val + ' violations (' + percentage + '%)';
                    }
                }
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    chart: {
                        height: 200
                    },
                    legend: {
                        fontSize: '10px'
                    }
                }
            }]
        };

        ppeEquipmentChartInstance = new ApexCharts(chartContainer, options);
        ppeEquipmentChartInstance.render();
        
        console.log('PPE equipment chart created successfully');
    } catch (error) {
        console.error('Error creating PPE equipment chart:', error);
    }
}

// Function to refresh PPE equipment chart
function refreshPPEEquipmentChart() {
    const chartContainer = document.getElementById('ppe-equipment-chart');
    if (!chartContainer) {
        console.error('PPE equipment chart container not found for refresh');
        return;
    }
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/ppe/api/equipment-violations/' + cameraId + '/';
    
    console.log('Refreshing PPE equipment chart data from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('Refreshed PPE equipment data:', data);
            
            if (ppeEquipmentChartInstance) {
                ppeEquipmentChartInstance.updateSeries(data.data);
                document.getElementById('ppe-chart-last-updated').textContent = new Date().toLocaleTimeString();
            }
        })
        .catch(error => {
            console.error('Error refreshing PPE equipment data:', error);
        });
}
</script>
{% endblock %}