{% extends 'core/base.html' %}
{% load static %}

{% block title %}Intrusion Detection - SOCA Edge{% endblock %}
{% block page_title %}Intrusion Detection{% endblock %}
{% block page_subtitle %}Real-time Security Intrusion Monitoring{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .detection-stats {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-active { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-danger { background-color: #dc3545; }
    
    .violation-alert {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .violation-count-card {
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .violation-count-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    #intrusions-1day, #intrusions-7days, #intrusions-30days {
        transition: transform 0.3s ease;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- ApexCharts - Modern, Popular Chart Library -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Column - Video Stream -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-camera-video me-2"></i>
                    Intrusion Detection Stream - {{ camera.name }}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="video-container">
                    <div id="video-debug" style="margin-bottom: 10px; padding: 5px; background: #f8f9fa; font-size: 12px;">
                        Stream URL: {% url 'intrusion_detection' camera.id %}
                    </div>
                    <img id="video-stream" 
                         src="{% url 'intrusion_detection' camera.id %}" 
                         alt="Intrusion Detection Stream" 
                         class="img-fluid w-100"
                         style="object-fit: contain; max-height: 600px;"
                         onerror="console.error('Video stream failed to load:', this.src); this.style.border='2px solid red'; document.getElementById('video-debug').style.background='#ffebee';"
                         onload="console.log('Video stream loaded successfully:', this.src); document.getElementById('video-debug').style.background='#e8f5e8';">
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col-md-3">
                        <small class="text-muted">Status</small><br>
                        <span class="status-indicator status-active"></span>
                        <strong class="text-success">Active</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Resolution</small><br>
                        <strong>{{ camera.resolution|default:"HD" }}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">FPS</small><br>
                        <strong>{{ camera.fps|default:"25" }}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Source</small><br>
                        <strong>{{ camera.camera_source }}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Intrusions Graph - Moved below video -->
        <div class="card mt-3">
            <div class="card-header bg-danger text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        Security Intrusions - Last 6 Hours (30min intervals)
                    </h6>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshIntrusionsChart()" title="Refresh Chart Data">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="chart-debug" style="margin-bottom: 10px; padding: 5px; background: #f8f9fa; font-size: 12px;">
                    Camera ID: {{ camera.id }} | Chart Status: Loading...
                </div>
                <div style="height: 300px; width: 100%;">
                    <div id="intrusionsChart" data-camera-id="{{ camera.id }}"></div>
                </div>
            </div>
        </div>
        
        <!-- Latest Incidents Section -->
        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-camera-fill me-2"></i>
                        Latest Security Incidents (5 Most Recent)
                    </h6>
                    <button class="btn btn-sm btn-outline-dark" onclick="refreshLatestIncidents()" title="Refresh Incidents">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="latest-incidents-container">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Loading latest incidents...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Column - Real-time Data -->
    <div class="col-lg-4">
        <!-- Intrusion Detection Stats -->
        <div class="stats-card">
            <h6><i class="bi bi-shield-exclamation me-2"></i>Security Status</h6>
            <div id="intrusion-stats-content">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Security Level</span>
                    <span class="h4 mb-0" id="security-level">HIGH</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <span>Active Threats</span>
                    <span class="h5 mb-0" id="active-threats">0</span>
                </div>
            </div>
        </div>
        
        
        <!-- Intrusion Counts -->
        <div class="detection-stats">
            <h6 class="text-danger mb-3">
                <i class="bi bi-shield-x me-2"></i>Intrusion Counts
            </h6>
            <div id="intrusion-counts">
                <div class="row text-center">
                    <div class="col-12 mb-3">
                        <div class="p-3 rounded" style="background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%); color: white;">
                            <h4 class="mb-0" id="intrusions-1day">0</h4>
                            <small class="opacity-90">Last 24 Hours</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-2 rounded border-end" style="background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%); color: white;">
                            <h5 class="mb-0" id="intrusions-7days">0</h5>
                            <small class="opacity-90">Last 7 Days</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-2 rounded" style="background: linear-gradient(135deg, #9B59B6 0%, #8E44AD 100%); color: white;">
                            <h5 class="mb-0" id="intrusions-30days">0</h5>
                            <small class="opacity-90">Last 30 Days</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background: #f8f9fa;">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>Last Updated
                            </small>
                            <small class="text-muted" id="intrusions-last-updated">
                                {{ current_time|date:"H:i" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Intrusion Severity Breakdown Chart -->
        <div class="detection-stats mt-3">
            <h6 class="text-danger mb-3">
                <i class="bi bi-exclamation-diamond me-2"></i>Intrusion Severity (Last 7 Days)
            </h6>
            <div id="intrusion-severity-chart" data-camera-id="{{ camera.id }}" style="height: 250px;"></div>
            <div class="mt-2">
                <small class="text-muted d-flex justify-content-between">
                    <span>Intrusions by severity level</span>
                    <span id="severity-chart-last-updated">Loading...</span>
                </small>
            </div>
        </div>
        
        <!-- Intrusion Type Breakdown Chart -->
        <div class="detection-stats mt-3">
            <h6 class="text-warning mb-3">
                <i class="bi bi-diagram-3 me-2"></i>Intrusion Types (Last 7 Days)
            </h6>
            <div id="intrusion-type-chart" data-camera-id="{{ camera.id }}" style="height: 250px;"></div>
            <div class="mt-2">
                <small class="text-muted d-flex justify-content-between">
                    <span>Intrusions by type</span>
                    <span id="type-chart-last-updated">Loading...</span>
                </small>
            </div>
        </div>
        
        <!-- System Information -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    System Information
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Camera ID:</span>
                        <span class="text-primary">{{ camera.id }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Detection Model:</span>
                        <span class="text-success">Security-YOLOv8</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Confidence:</span>
                        <span class="text-warning">0.7</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Last Update:</span>
                        <span class="text-muted" id="current-time">
                            {{ current_time|date:"H:i:s" }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-gear me-2"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" onclick="downloadSnapshot()">
                        <i class="bi bi-camera me-2"></i>Take Snapshot
                    </button>
                    <button class="btn btn-outline-warning btn-sm" type="button" onclick="adjustSensitivity()">
                        <i class="bi bi-sliders me-2"></i>Adjust Sensitivity
                    </button>
                    <button class="btn btn-outline-danger btn-sm" type="button" onclick="triggerAlert()">
                        <i class="bi bi-exclamation-triangle me-2"></i>Trigger Alert
                    </button>
                    <button class="btn btn-outline-info btn-sm" type="button" onclick="exportReport()">
                        <i class="bi bi-file-earmark-arrow-down me-2"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Functions for quick actions
function downloadSnapshot() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = document.getElementById('video-stream');
    
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    ctx.drawImage(img, 0, 0);
    
    const link = document.createElement('a');
    link.download = `intrusion-snapshot-${Date.now()}.png`;
    link.href = canvas.toDataURL();
    link.click();
}

function adjustSensitivity() {
    // This would open a modal or redirect to settings
    alert('Intrusion sensitivity adjustment feature would be implemented here');
}

function triggerAlert() {
    // This would trigger a security alert
    if (confirm('Are you sure you want to trigger a security alert?')) {
        alert('Security alert triggered! Authorities will be notified.');
    }
}

function exportReport() {
    // This would trigger a report generation
    alert('Intrusion report export feature would be implemented here');
}

// Auto-refresh video stream if it fails
document.getElementById('video-stream').onerror = function() {
    setTimeout(() => {
        this.src = this.src.split('?')[0] + '?t=' + Date.now();
    }, 5000);
};

// Update current time every second
setInterval(function() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {hour12: false});
    document.getElementById('current-time').textContent = timeString;
}, 1000);

// Create intrusions chart
function createIntrusionsChart() {
    try {
        const chartContainer = document.getElementById('intrusionsChart');
        if (!chartContainer) {
            console.error('Chart container not found');
            return;
        }
        
        // Test API connectivity first
        console.log('Testing API connectivity...');
        fetch('/intrusion/api/test/')
            .then(response => response.json())
            .then(data => {
                console.log('API test result:', data);
            })
            .catch(error => {
                console.error('API test failed:', error);
            });
        
        // Get intrusion data via AJAX
        const cameraId = chartContainer.dataset.cameraId;
        const apiUrl = '/intrusion/api/violations/' + cameraId + '/';
        document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | API URL: ' + apiUrl + ' | Chart Status: Fetching data...';
        
        console.log('Fetching data from:', apiUrl);
        console.log('Current browser time:', new Date().toLocaleString());
        console.log('Expected time range: Last 6 hours from now');
        
        fetch(apiUrl)
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(intrusionData => {
                console.log('Intrusion data received:', intrusionData);
                console.log('Data labels (time periods):', intrusionData.labels);
                console.log('Data values (intrusion counts):', intrusionData.data);
                console.log('Total data points:', intrusionData.data ? intrusionData.data.length : 0);
                
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Data loaded, creating chart...';
                
                if (!intrusionData || !intrusionData.labels || !intrusionData.data) {
                    console.error('Invalid intrusion data structure');
                    document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Error - Invalid data structure';
                    return;
                }
                
                // Check if all data is zeros and show helpful message
                const totalIntrusions = intrusionData.data.reduce((sum, val) => sum + val, 0);
                if (totalIntrusions === 0) {
                    console.log('No intrusion data found - showing empty chart');
                    document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: No intrusion data found for this time period | Tip: Run "python manage.py setup_intrusion_demo --enable-demo" to create sample data';
                }
                
                // Log time range for debugging
                const firstLabel = intrusionData.labels[0];
                const lastLabel = intrusionData.labels[intrusionData.labels.length - 1];
                console.log(`Chart time range: ${firstLabel} to ${lastLabel}`);
                
                // Create the chart with the fetched data
                createChartWithData(chartContainer, intrusionData);
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Chart created successfully | Time range: ' + firstLabel + ' to ' + lastLabel;
            })
            .catch(error => {
                console.error('Error fetching intrusion data:', error);
                document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Error - Using fallback data (' + error.message + ')';
                // Use fallback data for last 6 hours with 30-minute intervals (current time)
                const now = new Date();
                const fallbackLabels = [];
                
                // Use current time as end point (rounded to hour)
                const endTime = new Date(now);
                endTime.setMinutes(0, 0, 0);
                
                const startTime = new Date(endTime.getTime() - (6 * 60 * 60 * 1000));
                
                console.log('JavaScript fallback time range:', startTime.toLocaleString(), '→', endTime.toLocaleString());
                console.log('Using current time-based fallback data to show chart works');
                
                for (let i = 0; i < 12; i++) {
                    const timePoint = new Date(startTime.getTime() + (i * 30 * 60 * 1000));
                    const hours = timePoint.getHours().toString().padStart(2, '0');
                    const minutes = timePoint.getMinutes().toString().padStart(2, '0');
                    fallbackLabels.push(hours + ':' + minutes);
                }
                
                console.log('JavaScript fallback labels (current time):', fallbackLabels);
                // Sample data with some realistic intrusion patterns
                const fallbackData = {
                    labels: fallbackLabels,
                    data: [0, 1, 0, 2, 1, 0, 1, 3, 0, 1, 0, 2]
                };
                createChartWithData(chartContainer, fallbackData);
            });
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

function createChartWithData(chartContainer, intrusionData) {
    try {
        // ApexCharts Configuration
        const options = {
            series: [{
                name: 'Security Intrusions',
                data: intrusionData.data
            }],
            chart: {
                type: 'bar',
                height: 300,
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: false,
                        zoom: false,
                        zoomin: false,
                        zoomout: false,
                        pan: false,
                        reset: false
                    }
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 1200,
                    animateGradually: {
                        enabled: true,
                        delay: 100
                    }
                },
                background: 'transparent',
                foreColor: '#2C3E50'
            },
            plotOptions: {
                bar: {
                    borderRadius: 6,
                    columnWidth: '60%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val) {
                    // Only show labels for non-zero values
                    return val > 0 ? val : '';
                },
                offsetY: -25,
                style: {
                    fontSize: '12px',
                    fontWeight: 'bold',
                    colors: ['#E74C3C']
                },
                background: {
                    enabled: true,
                    foreColor: '#E74C3C',
                    borderColor: '#E74C3C',
                    borderWidth: 1,
                    borderRadius: 4,
                    padding: 4,
                    opacity: 0.1
                }
            },
            colors: ['#DC3545'],
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'light',
                    type: 'vertical',
                    shadeIntensity: 0.5,
                    gradientToColors: ['#C82333'],
                    inverseColors: false,
                    opacityFrom: 0.8,
                    opacityTo: 0.6,
                    stops: [0, 100]
                }
            },
            xaxis: {
                categories: intrusionData.labels,
                title: {
                    text: 'Time (Last 6 Hours - 30min intervals)',
                    style: {
                        fontSize: '12px',
                        fontWeight: 'bold',
                        color: '#2C3E50'
                    }
                },
                labels: {
                    style: {
                        fontSize: '10px',
                        colors: '#7F8C8D'
                    },
                    rotate: 0
                },
                axisBorder: {
                    show: true,
                    color: '#E0E0E0'
                },
                axisTicks: {
                    show: true,
                    color: '#E0E0E0'
                }
            },
            yaxis: {
                title: {
                    text: 'Number of Security Intrusions',
                    style: {
                        fontSize: '12px',
                        fontWeight: 'bold',
                        color: '#2C3E50'
                    }
                },
                labels: {
                    style: {
                        fontSize: '10px',
                        colors: '#7F8C8D'
                    },
                    formatter: function (val) {
                        return Math.floor(val) + (Math.floor(val) === 1 ? ' intrusion' : ' intrusions');
                    }
                },
                min: 0
            },
            title: {
                text: 'Security Intrusions Count (Last 6 Hours - 30min intervals)',
                align: 'center',
                margin: 20,
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    color: '#2C3E50'
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '12px'
                },
                custom: function({series, seriesIndex, dataPointIndex, w}) {
                    const value = series[seriesIndex][dataPointIndex];
                    const time = w.globals.labels[dataPointIndex];
                    
                    let status = '';
                    if (value === 0) {
                        status = '<div style="color: #28A745;"><i class="bi bi-shield-check"></i> Status: Secure</div>';
                    } else if (value <= 2) {
                        status = '<div style="color: #FFC107;"><i class="bi bi-exclamation-triangle"></i> Status: Minor Threats</div>';
                    } else {
                        status = '<div style="color: #DC3545;"><i class="bi bi-shield-exclamation"></i> Status: High Alert</div>';
                    }
                    
                    return `
                        <div style="padding: 10px; background: rgba(44, 62, 80, 0.95); border-radius: 6px; border: 1px solid #E74C3C;">
                            <div style="color: white; font-weight: bold; margin-bottom: 5px;">Time: ${time}</div>
                            <div style="color: white;">Security Intrusions: ${value} ${value === 1 ? 'incident' : 'incidents'}</div>
                            ${status}
                        </div>
                    `;
                }
            },
            grid: {
                borderColor: 'rgba(127, 140, 141, 0.2)',
                strokeDashArray: 3,
                xaxis: {
                    lines: {
                        show: false
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                }
            },
            states: {
                hover: {
                    filter: {
                        type: 'lighten',
                        value: 0.1
                    }
                },
                active: {
                    allowMultipleDataPointsSelection: false,
                    filter: {
                        type: 'darken',
                        value: 0.1
                    }
                }
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    chart: {
                        height: 250
                    },
                    plotOptions: {
                        bar: {
                            columnWidth: '80%'
                        }
                    },
                    dataLabels: {
                        style: {
                            fontSize: '10px'
                        }
                    }
                }
            }]
        };

        // Create the chart
        intrusionsChartInstance = new ApexCharts(chartContainer, options);
        intrusionsChartInstance.render();
        
        console.log('Chart created successfully');
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

// Global chart variable to store the chart instance
let intrusionsChartInstance = null;

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    createIntrusionsChart();
    updateIntrusionCounts(); // Load initial intrusion counts
    createIntrusionSeverityChart(); // Load intrusion severity chart
    createIntrusionTypeChart(); // Load intrusion type chart
    loadLatestIncidents(); // Load latest incidents
    
    // Set up automatic refresh every 15 seconds for real-time data
    setInterval(function() {
        refreshIntrusionsChart();
        updateIntrusionCounts();
        refreshIntrusionSeverityChart();
        refreshIntrusionTypeChart();
        refreshLatestIncidents();
    }, 2000); // 2 seconds
});

// Function to refresh chart data
function refreshIntrusionsChart() {
    const chartContainer = document.getElementById('intrusionsChart');
    if (!chartContainer) {
        console.error('Chart container not found for refresh');
        return;
    }
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/intrusion/api/violations/' + cameraId + '/';
    
    console.log('Refreshing chart data from:', apiUrl);
    document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Refreshing data...';
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(intrusionData => {
            console.log('Refreshed intrusion data:', intrusionData);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Data refreshed, updating chart...';
            
            if (!intrusionData || !intrusionData.labels || !intrusionData.data) {
                console.error('Invalid intrusion data structure on refresh');
                return;
            }
            
            // Update existing chart with new data
            updateChartData(intrusionData);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Chart updated successfully (Last refresh: ' + new Date().toLocaleTimeString() + ')';
        })
        .catch(error => {
            console.error('Error refreshing intrusion data:', error);
            document.getElementById('chart-debug').innerHTML = 'Camera ID: ' + cameraId + ' | Chart Status: Refresh failed (' + error.message + ')';
        });
}

// Function to update chart data without recreating the chart
function updateChartData(newData) {
    if (intrusionsChartInstance) {
        // ApexCharts update method
        intrusionsChartInstance.updateSeries([{
            name: 'Security Intrusions',
            data: newData.data
        }]);
        
        // Update categories (x-axis labels)
        intrusionsChartInstance.updateOptions({
            xaxis: {
                categories: newData.labels
            }
        });
        
        console.log('ApexChart data updated with animation');
    } else {
        console.error('ApexChart instance not found for update');
    }
}

// Function to update intrusion counts for different time periods
function updateIntrusionCounts() {
    const chartContainer = document.getElementById('intrusionsChart');
    if (!chartContainer) {
        console.error('Chart container not found for intrusion counts update');
        return;
    }
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/intrusion/api/summary/' + cameraId + '/';
    
    console.log('Fetching intrusion summary from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(summaryData => {
            console.log('Intrusion summary data:', summaryData);
            
            // Update the intrusion count displays with animation
            updateCountWithAnimation('intrusions-1day', summaryData.intrusions_1day);
            updateCountWithAnimation('intrusions-7days', summaryData.intrusions_7days);
            updateCountWithAnimation('intrusions-30days', summaryData.intrusions_30days);
            
            // Update last updated time
            document.getElementById('intrusions-last-updated').textContent = summaryData.last_updated;
            
            console.log('Intrusion counts updated successfully');
        })
        .catch(error => {
            console.error('Error fetching intrusion summary:', error);
            // Use fallback values on error
            document.getElementById('intrusions-1day').textContent = '—';
            document.getElementById('intrusions-7days').textContent = '—';
            document.getElementById('intrusions-30days').textContent = '—';
        });
}

// Function to animate count updates
function updateCountWithAnimation(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentValue = parseInt(element.textContent) || 0;
    
    if (currentValue !== newValue) {
        // Add animation class
        element.style.transform = 'scale(1.1)';
        element.style.transition = 'transform 0.3s ease';
        
        // Update value after short delay
        setTimeout(() => {
            element.textContent = newValue;
            element.style.transform = 'scale(1)';
        }, 150);
    } else {
        element.textContent = newValue;
    }
}

// Global variables for intrusion charts
let intrusionSeverityChartInstance = null;
let intrusionTypeChartInstance = null;

// Function to create intrusion severity chart
function createIntrusionSeverityChart() {
    try {
        const chartContainer = document.getElementById('intrusion-severity-chart');
        if (!chartContainer) {
            console.error('Intrusion severity chart container not found');
            return;
        }
        
        const cameraId = chartContainer.dataset.cameraId;
        const apiUrl = '/intrusion/api/severity-breakdown/' + cameraId + '/';
        
        console.log('Fetching intrusion severity data from:', apiUrl);
        document.getElementById('severity-chart-last-updated').textContent = 'Loading...';
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Intrusion severity data:', data);
                createIntrusionSeverityChartWithData(chartContainer, data);
                document.getElementById('severity-chart-last-updated').textContent = new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error fetching intrusion severity data:', error);
                // Use fallback data
                const fallbackData = {
                    labels: ['Low', 'Medium', 'High', 'Critical'],
                    data: [5, 8, 12, 3]
                };
                createIntrusionSeverityChartWithData(chartContainer, fallbackData);
                document.getElementById('severity-chart-last-updated').textContent = 'Error - Using sample data';
            });
    } catch (error) {
        console.error('Error creating intrusion severity chart:', error);
    }
}

// Note: Old PPE chart functions removed - this is now an intrusion detection dashboard

// Function to create intrusion severity chart with data
function createIntrusionSeverityChartWithData(chartContainer, data) {
    try {
        const options = {
            series: data.data,
            chart: {
                type: 'donut',
                height: 250,
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 1000
                }
            },
            labels: data.labels,
            colors: ['#28A745', '#FFC107', '#FD7E14', '#DC3545'],
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        labels: {
                            show: true,
                            name: {
                                show: true,
                                fontSize: '14px',
                                fontWeight: 'bold',
                                color: '#2C3E50'
                            },
                            value: {
                                show: true,
                                fontSize: '16px',
                                fontWeight: 'bold',
                                color: '#DC3545',
                                formatter: function (val) {
                                    return val + ' incidents';
                                }
                            },
                            total: {
                                show: true,
                                label: 'Total',
                                fontSize: '14px',
                                fontWeight: 'bold',
                                color: '#2C3E50',
                                formatter: function (w) {
                                    const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    return total + ' incidents';
                                }
                            }
                        }
                    }
                }
            },
            legend: {
                position: 'bottom',
                fontSize: '12px'
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val + ' incidents';
                    }
                }
            }
        };

        intrusionSeverityChartInstance = new ApexCharts(chartContainer, options);
        intrusionSeverityChartInstance.render();
        
        console.log('Intrusion severity chart created successfully');
    } catch (error) {
        console.error('Error creating intrusion severity chart:', error);
    }
}

// Function to create intrusion type chart
function createIntrusionTypeChart() {
    try {
        const chartContainer = document.getElementById('intrusion-type-chart');
        if (!chartContainer) {
            console.error('Intrusion type chart container not found');
            return;
        }
        
        const cameraId = chartContainer.dataset.cameraId;
        const apiUrl = '/intrusion/api/type-breakdown/' + cameraId + '/';
        
        console.log('Fetching intrusion type data from:', apiUrl);
        document.getElementById('type-chart-last-updated').textContent = 'Loading...';
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Intrusion type data:', data);
                createIntrusionTypeChartWithData(chartContainer, data);
                document.getElementById('type-chart-last-updated').textContent = new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error fetching intrusion type data:', error);
                // Use fallback data
                const fallbackData = {
                    labels: ['Unauthorized Entry', 'Restricted Area', 'After Hours', 'Unknown'],
                    data: [15, 8, 5, 2]
                };
                createIntrusionTypeChartWithData(chartContainer, fallbackData);
                document.getElementById('type-chart-last-updated').textContent = 'Error - Using sample data';
            });
    } catch (error) {
        console.error('Error creating intrusion type chart:', error);
    }
}

// Function to create intrusion type chart with data
function createIntrusionTypeChartWithData(chartContainer, data) {
    try {
        const options = {
            series: [{
                name: 'Intrusions',
                data: data.data
            }],
            chart: {
                type: 'bar',
                height: 250,
                horizontal: true
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            dataLabels: {
                enabled: true,
                offsetX: -6,
                style: {
                    fontSize: '12px',
                    colors: ['#fff']
                }
            },
            xaxis: {
                categories: data.labels
            },
            colors: ['#FF6B6B'],
            title: {
                text: 'Intrusion Types',
                align: 'center'
            }
        };

        intrusionTypeChartInstance = new ApexCharts(chartContainer, options);
        intrusionTypeChartInstance.render();
        
        console.log('Intrusion type chart created successfully');
    } catch (error) {
        console.error('Error creating intrusion type chart:', error);
    }
}

// Function to refresh intrusion severity chart
function refreshIntrusionSeverityChart() {
    const chartContainer = document.getElementById('intrusion-severity-chart');
    if (!chartContainer) return;
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/intrusion/api/severity-breakdown/' + cameraId + '/';
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (intrusionSeverityChartInstance) {
                intrusionSeverityChartInstance.updateSeries(data.data);
                document.getElementById('severity-chart-last-updated').textContent = new Date().toLocaleTimeString();
            }
        })
        .catch(error => console.error('Error refreshing severity chart:', error));
}

// Function to refresh intrusion type chart
function refreshIntrusionTypeChart() {
    const chartContainer = document.getElementById('intrusion-type-chart');
    if (!chartContainer) return;
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/intrusion/api/type-breakdown/' + cameraId + '/';
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (intrusionTypeChartInstance) {
                intrusionTypeChartInstance.updateSeries([{
                    name: 'Intrusions',
                    data: data.data
                }]);
                document.getElementById('type-chart-last-updated').textContent = new Date().toLocaleTimeString();
            }
        })
        .catch(error => console.error('Error refreshing type chart:', error));
}

// Function to load latest incidents
function loadLatestIncidents() {
    const chartContainer = document.getElementById('intrusionsChart');
    if (!chartContainer) {
        console.error('Chart container not found for incidents');
        return;
    }
    
    const cameraId = chartContainer.dataset.cameraId;
    const apiUrl = '/intrusion/api/latest-incidents/' + cameraId + '/';
    
    console.log('Loading latest incidents from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('Latest incidents data:', data);
            displayLatestIncidents(data.incidents);
        })
        .catch(error => {
            console.error('Error loading latest incidents:', error);
            displayNoIncidents();
        });
}

// Function to refresh latest incidents
function refreshLatestIncidents() {
    loadLatestIncidents();
}

// Function to display latest incidents
function displayLatestIncidents(incidents) {
    const container = document.getElementById('latest-incidents-container');
    
    if (!incidents || incidents.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-shield-check display-6 mb-3"></i>
                <p class="mb-0">No recent security incidents</p>
                <small>The area has been secure</small>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    
    incidents.forEach((incident, index) => {
        const severityColor = getSeverityColor(incident.severity);
        const severityIcon = getSeverityIcon(incident.severity);
        
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-${severityColor} incident-card" data-incident-id="${incident.id}">
                    <div class="card-header bg-${severityColor} text-white p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="fw-bold">
                                <i class="${severityIcon} me-1"></i>
                                ${incident.severity.toUpperCase()}
                            </small>
                            <small>${incident.timestamp_relative}</small>
                        </div>
                    </div>
                    ${incident.snapshot_url ? `
                        <div class="card-img-container" style="height: 150px; overflow: hidden;">
                            <img src="${incident.snapshot_url}" 
                                 class="card-img-top" 
                                 style="height: 100%; width: 100%; object-fit: cover; cursor: pointer;"
                                 alt="Incident ${incident.id}"
                                 onclick="openImageModal('${incident.snapshot_url}', 'Incident ${incident.id} - ${incident.timestamp}')"
                                 onerror="this.parentElement.innerHTML='<div class=\\'d-flex align-items-center justify-content-center h-100 bg-light text-muted\\'>No Image</div>'">
                        </div>
                    ` : `
                        <div class="d-flex align-items-center justify-content-center bg-light text-muted" style="height: 150px;">
                            <i class="bi bi-camera-slash-fill display-6"></i>
                        </div>
                    `}
                    <div class="card-body p-2">
                        <div class="small">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Type:</span>
                                <span class="fw-bold">${incident.intrusion_type.replace('_', ' ')}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Objects:</span>
                                <span>${incident.object_count}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Time:</span>
                                <span>${incident.timestamp.split(' ')[1]}</span>
                            </div>
                            ${incident.description ? `
                                <div class="mt-2">
                                    <small class="text-muted">${incident.description}</small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Function to display no incidents message
function displayNoIncidents() {
    const container = document.getElementById('latest-incidents-container');
    container.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="bi bi-exclamation-triangle display-6 mb-3"></i>
            <p class="mb-0">Unable to load recent incidents</p>
            <small>Please try refreshing</small>
        </div>
    `;
}

// Helper function to get severity color
function getSeverityColor(severity) {
    switch(severity.toLowerCase()) {
        case 'critical': return 'danger';
        case 'high': return 'warning';
        case 'medium': return 'info';
        case 'low': return 'success';
        default: return 'secondary';
    }
}

// Helper function to get severity icon
function getSeverityIcon(severity) {
    switch(severity.toLowerCase()) {
        case 'critical': return 'bi bi-exclamation-triangle-fill';
        case 'high': return 'bi bi-exclamation-circle-fill';
        case 'medium': return 'bi bi-info-circle-fill';
        case 'low': return 'bi bi-check-circle-fill';
        default: return 'bi bi-question-circle-fill';
    }
}

// Function to open image modal for viewing snapshots
function openImageModal(imageUrl, title) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('imageModal');
    if (!modal) {
        const modalHtml = `
            <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="imageModalTitle">Incident Snapshot</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img id="modalImage" src="" class="img-fluid" alt="Incident Snapshot">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <a id="downloadImageBtn" href="" download class="btn btn-primary">
                                <i class="bi bi-download me-2"></i>Download
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('imageModal');
    }
    
    // Set modal content
    document.getElementById('imageModalTitle').textContent = title;
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('downloadImageBtn').href = imageUrl;
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Add CSS for incident cards
const incidentCardCSS = `
<style>
.incident-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.incident-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.card-img-container img:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}
</style>
`;

// Add CSS to head
document.head.insertAdjacentHTML('beforeend', incidentCardCSS);
</script>
{% endblock %}